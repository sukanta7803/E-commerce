<%- include('../partials/header') %>

<div class="container">
  <div class="profile-page">
    <aside class="profile-sidebar">
      <nav class="profile-nav">
        <a href="/user/profile" class="active">Profile</a>
        <a href="/orders">My Orders</a>
        <a href="/user/addresses">Addresses</a>
         <a href="/auth/logout">Logout</a>
      </nav>
    </aside>

    <div class="profile-content">
      <h1>My Addresses</h1>

      <button class="btn btn-primary" onclick="showAddAddressForm()">Add New Address</button>

      <div id="add-address-form" class="address-form" style="display: none;">
        <h2>Add New Address</h2>
        <form onsubmit="addAddress(event)">
          <div class="form-group">
            <label>Label (e.g., Home, Work)</label>
            <input type="text" name="label" required>
          </div>
          <div class="form-group">
            <label>Full Name</label>
            <input type="text" name="fullName" required>
          </div>
          <div class="form-group">
            <label>Phone</label>
            <input type="tel" name="phone" required>
          </div>
          <div class="form-group">
            <label>Address Line 1</label>
            <input type="text" name="addressLine1" required>
          </div>
          <div class="form-group">
            <label>Address Line 2</label>
            <input type="text" name="addressLine2">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>City</label>
              <input type="text" name="city" required>
            </div>
            <div class="form-group">
              <label>State</label>
              <input type="text" name="state" required>
            </div>
            <div class="form-group">
              <label>Zip Code</label>
              <input type="text" name="zipCode" required>
            </div>
          </div>
          <label>
            <input type="checkbox" name="isDefault" value="true">
            Set as default address
          </label>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Save Address</button>
            <button type="button" class="btn btn-secondary" onclick="hideAddAddressForm()">Cancel</button>
          </div>
        </form>
      </div>

      <div class="addresses-list">
        <% if (addresses.length === 0) { %>
          <p>No addresses saved yet.</p>
        <% } else { %>
          <% addresses.forEach(address => { %>
            <div class="address-card">
              <div class="address-header">
                <strong><%= address.label %></strong>
                <% if (address.isDefault) { %>
                  <span class="default-badge">Default</span>
                <% } %>
              </div>
              <p><%= address.fullName %></p>
              <p><%= address.addressLine1 %></p>
              <% if (address.addressLine2) { %>
                <p><%= address.addressLine2 %></p>
              <% } %>
              <p><%= address.city %>, <%= address.state %> <%= address.zipCode %></p>
              <p><%= address.phone %></p>
              <button class="btn-remove" onclick="deleteAddress('<%= address._id %>')">Delete</button>
            </div>
          <% }) %>
        <% } %>
      </div>
    </div>
  </div>
</div>

<script>
function showAddAddressForm() {
  document.getElementById('add-address-form').style.display = 'block';
}

function hideAddAddressForm() {
  document.getElementById('add-address-form').style.display = 'none';
}

async function addAddress(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = Object.fromEntries(formData);

  try {
    const response = await fetch('/user/addresses/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    const result = await response.json();
    if (result.success) {
      alert('Address added successfully');
      location.reload();
    } else {
      alert(result.message);
    }
  } catch (error) {
    alert('An error occurred');
  }
}

async function deleteAddress(addressId) {
  if (!confirm('Are you sure you want to delete this address?')) return;

  try {
    const response = await fetch(`/user/addresses/${addressId}`, {
      method: 'DELETE'
    });

    const result = await response.json();
    if (result.success) {
      alert('Address deleted successfully');
      location.reload();
    } else {
      alert(result.message);
    }
  } catch (error) {
    alert('An error occurred');
  }
}
</script>

<%- include('../partials/footer') %>
