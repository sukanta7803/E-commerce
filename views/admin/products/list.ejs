<%- include('../../partials/header') %>

<div class="container">
  <div class="admin-page">
    <aside class="admin-sidebar">
      <h2>Admin Panel</h2>
      <nav class="admin-nav">
        <a href="/admin/dashboard">Dashboard</a>
        <a href="/admin/products" class="active">Products</a>
        <a href="/admin/categories">Categories</a>
        <a href="/admin/orders">Orders</a>
        <a href="/admin/customers">Customers</a>
        <a href="/admin/reviews">Reviews</a>
      </nav>
    </aside>

    <div class="admin-content">
      <div class="admin-header">
        <h1>Manage Products</h1>
        <a href="/admin/products/add" class="btn btn-primary">Add New Product</a>
      </div>

      <div class="table-responsive">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Image</th>
              <th>Name</th>
              <th>SKU</th>
              <th>Price</th>
              <th>Stock</th>
              <th>Category</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% products.forEach(product => { %>
              <tr>
                <td>
                  <img src="<%= product.images[0]?.url || '/images/placeholder.jpg' %>" alt="<%= product.name %>" class="table-image">
                </td>
                <td><%= product.name %></td>
                <td><%= product.sku %></td>
                <td>$<%= (product.salePrice || product.price).toFixed(2) %></td>
                <td <%= product.stock <= product.lowStockThreshold ? 'class="low-stock"' : '' %>>
                  <%= product.stock %>
                </td>
                <td><%= product.category.name %></td>
                <td>
                  <span class="status-badge <%= product.isActive ? 'status-active' : 'status-inactive' %>">
                    <%= product.isActive ? 'Active' : 'Inactive' %>
                  </span>
                </td>
                <td class="actions">
                  <a href="/admin/products/edit/<%= product._id %>" class="btn-small">Edit</a>
                  <button class="btn-small btn-danger" onclick="deleteProduct('<%= product._id %>')">Delete</button>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <% if (totalPages > 1) { %>
        <div class="pagination">
          <% if (currentPage > 1) { %>
            <a href="?page=<%= currentPage - 1 %>" class="btn">Previous</a>
          <% } %>

          <% for (let i = 1; i <= totalPages; i++) { %>
            <% if (i === currentPage) { %>
              <span class="current-page"><%= i %></span>
            <% } else if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) { %>
              <a href="?page=<%= i %>"><%= i %></a>
            <% } else if (i === currentPage - 3 || i === currentPage + 3) { %>
              <span>...</span>
            <% } %>
          <% } %>

          <% if (currentPage < totalPages) { %>
            <a href="?page=<%= currentPage + 1 %>" class="btn">Next</a>
          <% } %>
        </div>
      <% } %>
    </div>
  </div>
</div>

<script>
async function deleteProduct(productId) {
  if (!confirm('Are you sure you want to delete this product?')) return;

  try {
    const response = await fetch(`/admin/products/${productId}`, {
      method: 'DELETE'
    });

    const result = await response.json();
    if (result.success) {
      alert('Product deleted successfully');
      location.reload();
    } else {
      alert(result.message);
    }
  } catch (error) {
    alert('An error occurred');
  }
}
</script>

<%- include('../../partials/footer') %>
