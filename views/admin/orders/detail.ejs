<%- include('../../partials/header') %>

<div class="container">
  <div class="admin-page">
    <aside class="admin-sidebar">
      <h2>Admin Panel</h2>
      <nav class="admin-nav">
        <a href="/admin/dashboard">Dashboard</a>
        <a href="/admin/products">Products</a>
        <a href="/admin/categories">Categories</a>
        <a href="/admin/orders" class="active">Orders</a>
        <a href="/admin/customers">Customers</a>
        <a href="/admin/reviews">Reviews</a>
      </nav>
    </aside>

    <div class="admin-content">
      <h1>Order Details - <%= order.orderNumber %></h1>

      <div class="order-admin-content">
        <section class="order-section">
          <h2>Customer Information</h2>
          <p><strong>Name:</strong> <%= order.user.name %></p>
          <p><strong>Email:</strong> <%= order.user.email %></p>
          <p><strong>Phone:</strong> <%= order.user.phone || 'N/A' %></p>
        </section>

        <section class="order-section">
          <h2>Shipping Address</h2>
          <p><%= order.shippingAddress.fullName %></p>
          <p><%= order.shippingAddress.addressLine1 %></p>
          <% if (order.shippingAddress.addressLine2) { %>
            <p><%= order.shippingAddress.addressLine2 %></p>
          <% } %>
          <p><%= order.shippingAddress.city %>, <%= order.shippingAddress.state %> <%= order.shippingAddress.zipCode %></p>
          <p><%= order.shippingAddress.phone %></p>
        </section>

        <section class="order-section">
          <h2>Update Order Status</h2>
          <form onsubmit="updateOrderStatus(event, '<%= order._id %>')">
            <div class="form-group">
              <label>Status</label>
              <select name="status">
                <option value="pending" <%= order.status === 'pending' ? 'selected' : '' %>>Pending</option>
                <option value="processing" <%= order.status === 'processing' ? 'selected' : '' %>>Processing</option>
                <option value="shipped" <%= order.status === 'shipped' ? 'selected' : '' %>>Shipped</option>
                <option value="delivered" <%= order.status === 'delivered' ? 'selected' : '' %>>Delivered</option>
                <option value="cancelled" <%= order.status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
              </select>
            </div>
            <div class="form-group">
              <label>Tracking Number</label>
              <input type="text" name="trackingNumber" value="<%= order.trackingNumber || '' %>">
            </div>
            <div class="form-group">
              <label>Note</label>
              <input type="text" name="note">
            </div>
            <button type="submit" class="btn btn-primary">Update Status</button>
          </form>
        </section>

        <section class="order-section">
          <h2>Order Items</h2>
          <table class="admin-table">
            <thead>
              <tr>
                <th>Product</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              <% order.items.forEach(item => { %>
                <tr>
                  <td><%= item.name %></td>
                  <td><%= item.quantity %></td>
                  <td>$<%= item.price.toFixed(2) %></td>
                  <td>$<%= (item.price * item.quantity).toFixed(2) %></td>
                </tr>
              <% }) %>
            </tbody>
          </table>

          <div class="order-totals">
            <p>Subtotal: $<%= order.subtotal.toFixed(2) %></p>
            <p>Shipping: $<%= order.shippingCost.toFixed(2) %></p>
            <p>Tax: $<%= order.tax.toFixed(2) %></p>
            <p><strong>Total: $<%= order.total.toFixed(2) %></strong></p>
          </div>
        </section>

        <section class="order-section">
          <h2>Status History</h2>
          <% order.statusHistory.forEach(history => { %>
            <div class="history-item">
              <strong><%= new Date(history.timestamp).toLocaleString() %></strong>
              <p><%= history.note %></p>
            </div>
          <% }) %>
        </section>
      </div>
    </div>
  </div>
</div>

<script>
async function updateOrderStatus(e, orderId) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = Object.fromEntries(formData);

  try {
    const response = await fetch(`/admin/orders/${orderId}/update-status`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    const result = await response.json();
    if (result.success) {
      alert('Order status updated successfully');
      location.reload();
    } else {
      alert(result.message);
    }
  } catch (error) {
    alert('An error occurred');
  }
}
</script>

<%- include('../../partials/footer') %>
